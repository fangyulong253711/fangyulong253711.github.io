<template><h1 id="kube-apiserver源码" tabindex="-1"><a class="header-anchor" href="#kube-apiserver源码" aria-hidden="true">#</a> kube-apiserver源码</h1>
<h2 id="_1-入口函数" tabindex="-1"><a class="header-anchor" href="#_1-入口函数" aria-hidden="true">#</a> 1 入口函数</h2>
<p>cmd/kube-apiserver/apiserver.go</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

   command <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   logs<span class="token punctuation">.</span><span class="token function">InitLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">defer</span> logs<span class="token punctuation">.</span><span class="token function">FlushLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

   <span class="token keyword">if</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>主要是NewAPIServerCommand()执行,接下来我们就看看他的执行过程</p>
<h2 id="command创建过程" tabindex="-1"><a class="header-anchor" href="#command创建过程" aria-hidden="true">#</a> Command创建过程</h2>
<p>cmd/kube-apiserver/app/server.go
1 初始化command 核心为其中的Run()函数</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// NewAPIServerCommand creates a *cobra.Command object with default parameters</span>
<span class="token keyword">func</span> <span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
   s <span class="token operator">:=</span> options<span class="token punctuation">.</span><span class="token function">NewServerRunOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
      Use<span class="token punctuation">:</span> <span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span>
      Long<span class="token punctuation">:</span> <span class="token string">`The Kubernetes API server validates and configures data
for the api objects which include pods, services, replicationcontrollers, and
others. The API Server services REST operations and provides the frontend to the
cluster's shared state through which all other components interact.`</span><span class="token punctuation">,</span>
      RunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
         verflag<span class="token punctuation">.</span><span class="token function">PrintAndExitIfRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         utilflag<span class="token punctuation">.</span><span class="token function">PrintFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

         <span class="token comment">// set default options</span>
         completedOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Complete</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
         <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
         <span class="token punctuation">}</span>

         <span class="token comment">// validate options</span>
         <span class="token keyword">if</span> errs <span class="token operator">:=</span> completedOptions<span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>

         <span class="token keyword">return</span> <span class="token function">Run</span><span class="token punctuation">(</span>completedOptions<span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span>

   fs <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   namedFlagSets <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   verflag<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>namedFlagSets<span class="token punctuation">.</span><span class="token function">FlagSet</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   globalflag<span class="token punctuation">.</span><span class="token function">AddGlobalFlags</span><span class="token punctuation">(</span>namedFlagSets<span class="token punctuation">.</span><span class="token function">FlagSet</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   options<span class="token punctuation">.</span><span class="token function">AddCustomGlobalFlags</span><span class="token punctuation">(</span>namedFlagSets<span class="token punctuation">.</span><span class="token function">FlagSet</span><span class="token punctuation">(</span><span class="token string">"generic"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> namedFlagSets<span class="token punctuation">.</span>FlagSets <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">AddFlagSet</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   usageFmt <span class="token operator">:=</span> <span class="token string">"Usage:\n  %s\n"</span>
   cols<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> term<span class="token punctuation">.</span><span class="token function">TerminalSize</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">SetUsageFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStderr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> usageFmt<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">UseLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      cliflag<span class="token punctuation">.</span><span class="token function">PrintSections</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStderr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> namedFlagSets<span class="token punctuation">,</span> cols<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">SetHelpFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s\n\n"</span><span class="token operator">+</span>usageFmt<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>Long<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">UseLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      cliflag<span class="token punctuation">.</span><span class="token function">PrintSections</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> namedFlagSets<span class="token punctuation">,</span> cols<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

   <span class="token keyword">return</span> cmd
<span class="token punctuation">}</span>





<span class="token comment">// completeOptions 是初始化的模板   stopCh是创建的时候传入的信号量 可以根据他停止进程</span>
<span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>completeOptions completedServerRunOptions<span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// To help debugging, immediately log version</span>
	klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Version: %+v"</span><span class="token punctuation">,</span> version<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	server<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span>completeOptions<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	prepared<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> prepared<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h2 id="server的创建" tabindex="-1"><a class="header-anchor" href="#server的创建" aria-hidden="true">#</a> server的创建</h2>
<p>在上述代码中主要和server创建相关的是CreateServerChain 我们就来看看CreateServerChain</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// 在CreateServerChain这个函数下，创建了3个server</span>
<span class="token keyword">func</span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token comment">// kubeapiserver 的配置创建</span>
    <span class="token function">CreateKubeAPIServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// kube 额外配置的创建</span>
    <span class="token function">createAPIExtensionsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// API扩展服务，主要针对CRD</span>
	<span class="token function">createAPIExtensionsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
  <span class="token comment">// API核心服务，包括常见的Pod/Deployment/Service，我们今天的重点聚焦在这里</span>
  <span class="token comment">// 我会跳过很多非核心的配置参数，一开始就去研究细节，很影响整体代码的阅读效率</span>
	<span class="token function">CreateKubeAPIServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
  <span class="token comment">// API聚合服务，主要针对metrics</span>
	<span class="token function">createAggregatorServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="createkubeapiserver-apiserver的创建" tabindex="-1"><a class="header-anchor" href="#createkubeapiserver-apiserver的创建" aria-hidden="true">#</a> CreateKubeAPIServer()  apiserver的创建</h2>
<p>cmd/kube-apiserver/app/server.go</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//首先调用complete 进行参数的填充  然后调用new进行实例化</span>
<span class="token keyword">func</span> <span class="token function">CreateKubeAPIServer</span><span class="token punctuation">(</span>kubeAPIServerConfig <span class="token operator">*</span>master<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> delegateAPIServer genericapiserver<span class="token punctuation">.</span>DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>master<span class="token punctuation">.</span>Master<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   kubeAPIServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubeAPIServerConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> kubeAPIServer<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可见他是调用了New函数</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>delegationTarget genericapiserver<span class="token punctuation">.</span>DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Master<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">,</span> kubeletclient<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Master.New() called with empty config.KubeletClientConfig"</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
	<span class="token comment">// 使用通用配置 new一个config</span>
    
   s<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span> delegationTarget<span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>EnableLogsSupport <span class="token punctuation">{</span>
      routes<span class="token punctuation">.</span>Logs<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">Install</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span>GoRestfulContainer<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>ServiceAccountIssuerDiscovery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Metadata and keys are expected to only change across restarts at present,</span>
      <span class="token comment">// so we just marshal immediately and serve the cached JSON bytes.</span>
      md<span class="token punctuation">,</span> err <span class="token operator">:=</span> serviceaccount<span class="token punctuation">.</span><span class="token function">NewOpenIDMetadata</span><span class="token punctuation">(</span>
         c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountIssuerURL<span class="token punctuation">,</span>
         c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountJWKSURI<span class="token punctuation">,</span>
         c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>ExternalAddress<span class="token punctuation">,</span>
         c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountPublicKeys<span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token comment">// If there was an error, skip installing the endpoints and log the</span>
         <span class="token comment">// error, but continue on. We don't return the error because the</span>
         <span class="token comment">// metadata responses require additional, backwards incompatible</span>
         <span class="token comment">// validation of command-line options.</span>
         msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Could not construct pre-rendered responses for"</span><span class="token operator">+</span>
            <span class="token string">" ServiceAccountIssuerDiscovery endpoints. Endpoints will not be"</span><span class="token operator">+</span>
            <span class="token string">" enabled. Error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
         <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountIssuerURL <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            <span class="token comment">// The user likely expects this feature to be enabled if issuer URL is</span>
            <span class="token comment">// set and the feature gate is enabled. In the future, if there is no</span>
            <span class="token comment">// longer a feature gate and issuer URL is not set, the user may not</span>
            <span class="token comment">// expect this feature to be enabled. We log the former case as an Error</span>
            <span class="token comment">// and the latter case as an Info.</span>
            klog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         routes<span class="token punctuation">.</span><span class="token function">NewOpenIDMetadataServer</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span>ConfigJSON<span class="token punctuation">,</span> md<span class="token punctuation">.</span>PublicKeysetJSON<span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">Install</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span>GoRestfulContainer<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>
      GenericAPIServer<span class="token punctuation">:</span>          s<span class="token punctuation">,</span>
      ClusterAuthenticationInfo<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// install legacy rest storage</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">.</span><span class="token function">VersionEnabled</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      legacyRESTStorageProvider <span class="token operator">:=</span> corerest<span class="token punctuation">.</span>LegacyRESTStorageProvider<span class="token punctuation">{</span>
         StorageFactory<span class="token punctuation">:</span>              c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>StorageFactory<span class="token punctuation">,</span>
         ProxyTransport<span class="token punctuation">:</span>              c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ProxyTransport<span class="token punctuation">,</span>
         KubeletClientConfig<span class="token punctuation">:</span>         c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">,</span>
         EventTTL<span class="token punctuation">:</span>                    c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>EventTTL<span class="token punctuation">,</span>
         ServiceIPRange<span class="token punctuation">:</span>              c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceIPRange<span class="token punctuation">,</span>
         SecondaryServiceIPRange<span class="token punctuation">:</span>     c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>SecondaryServiceIPRange<span class="token punctuation">,</span>
         ServiceNodePortRange<span class="token punctuation">:</span>        c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceNodePortRange<span class="token punctuation">,</span>
         LoopbackClientConfig<span class="token punctuation">:</span>        c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>
         ServiceAccountIssuer<span class="token punctuation">:</span>        c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountIssuer<span class="token punctuation">,</span>
         ServiceAccountMaxExpiration<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountMaxExpiration<span class="token punctuation">,</span>
         APIAudiences<span class="token punctuation">:</span>                c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// The order here is preserved in discovery.</span>
   <span class="token comment">// If resources with identical names exist in more than one of these groups (e.g. "deployments.apps"" and "deployments.extensions"),</span>
   <span class="token comment">// the order of this list determines which group an unqualified resource name (e.g. "deployments") should prefer.</span>
   <span class="token comment">// This priority order is used for local discovery, but it ends up aggregated in `k8s.io/kubernetes/cmd/kube-apiserver/app/aggregator.go</span>
   <span class="token comment">// with specific priorities.</span>
   <span class="token comment">// TODO: describe the priority all the way down in the RESTStorageProviders and plumb it back through the various discovery</span>
   <span class="token comment">// handlers that we have.</span>
   restStorageProviders <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>RESTStorageProvider<span class="token punctuation">{</span>
      auditregistrationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      authenticationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authenticator<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> APIAudiences<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">}</span><span class="token punctuation">,</span>
      authorizationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authorizer<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> RuleResolver<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">}</span><span class="token punctuation">,</span>
      autoscalingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      batchrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      certificatesrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      coordinationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      discoveryrest<span class="token punctuation">.</span>StorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      extensionsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      networkingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      noderest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      policyrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      rbacrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authorizer<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">}</span><span class="token punctuation">,</span>
      schedulingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      settingsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      storagerest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      flowcontrolrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.</span>
      <span class="token comment">// See https://github.com/kubernetes/kubernetes/issues/42392</span>
      appsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      admissionregistrationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      eventsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>TTL<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>EventTTL<span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>Tunneler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      m<span class="token punctuation">.</span><span class="token function">installTunneler</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>Tunneler<span class="token punctuation">,</span> corev1client<span class="token punctuation">.</span><span class="token function">NewForConfigOrDie</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHookOrDie</span><span class="token punctuation">(</span><span class="token string">"start-cluster-authentication-info-controller"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>hookContext genericapiserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
      kubeClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubernetes<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>hookContext<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> err
      <span class="token punctuation">}</span>
      controller <span class="token operator">:=</span> clusterauthenticationtrust<span class="token punctuation">.</span><span class="token function">NewClusterAuthenticationTrustController</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span> kubeClient<span class="token punctuation">)</span>

      <span class="token comment">// prime values and start listeners</span>
      <span class="token keyword">if</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>ClientCA <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> notifier<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>ClientCA<span class="token punctuation">.</span><span class="token punctuation">(</span>dynamiccertificates<span class="token punctuation">.</span>Notifier<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            notifier<span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span> controller<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>ClientCA<span class="token punctuation">.</span><span class="token punctuation">(</span>dynamiccertificates<span class="token punctuation">.</span>ControllerRunner<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token comment">// runonce to be sure that we have a value.</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">RunOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
               runtime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">go</span> controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> hookContext<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>RequestHeaderCA <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> notifier<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>RequestHeaderCA<span class="token punctuation">.</span><span class="token punctuation">(</span>dynamiccertificates<span class="token punctuation">.</span>Notifier<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            notifier<span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span> controller<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>RequestHeaderCA<span class="token punctuation">.</span><span class="token punctuation">(</span>dynamiccertificates<span class="token punctuation">.</span>ControllerRunner<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token comment">// runonce to be sure that we have a value.</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">RunOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
               runtime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">go</span> controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> hookContext<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">go</span> controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> hookContext<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

   <span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br></div></div><h2 id="genericconfig-new-设置的初始化" tabindex="-1"><a class="header-anchor" href="#genericconfig-new-设置的初始化" aria-hidden="true">#</a> GenericConfig.New() 设置的初始化</h2>
<p>在上述代码中 有用new进行初始化了一个config对象</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// 都通过GenericConfig创建了genericServer，我们先大致浏览下</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> delegationTarget DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>GenericAPIServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 新建Handler</span>
	apiServerHandler <span class="token operator">:=</span> <span class="token function">NewAPIServerHandler</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> handlerChainBuilder<span class="token punctuation">,</span> delegationTarget<span class="token punctuation">.</span><span class="token function">UnprotectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  
	<span class="token comment">// 实例化一个Server</span>
	s <span class="token operator">:=</span> <span class="token operator">&amp;</span>GenericAPIServer<span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

	<span class="token comment">// 处理钩子hook操作</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> delegationTarget<span class="token punctuation">.</span><span class="token function">PostStartHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>postStartHooks<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> delegationTarget<span class="token punctuation">.</span><span class="token function">PreShutdownHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>preShutdownHooks<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>

	<span class="token comment">// 健康监测</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> delegateCheck <span class="token operator">:=</span> <span class="token keyword">range</span> delegationTarget<span class="token punctuation">.</span><span class="token function">HealthzChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		skip <span class="token operator">:=</span> <span class="token boolean">false</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> existingCheck <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>HealthzChecks <span class="token punctuation">{</span>
			<span class="token keyword">if</span> existingCheck<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> delegateCheck<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				skip <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> skip <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		s<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span>delegateCheck<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
  <span class="token comment">// 安装API相关参数，这个是重点</span>
	<span class="token function">installAPI</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>

	<span class="token keyword">return</span> s<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="apiserver的创建" tabindex="-1"><a class="header-anchor" href="#apiserver的创建" aria-hidden="true">#</a> Apiserver的创建</h2>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>delegationTarget genericapiserver<span class="token punctuation">.</span>DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Master<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// genericServer的初始化</span>
	s<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span> delegationTarget<span class="token punctuation">)</span>
	<span class="token comment">// 核心KubeAPIServer的实例化</span>
	m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>
		GenericAPIServer<span class="token punctuation">:</span>          s<span class="token punctuation">,</span>
		ClusterAuthenticationInfo<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 注册Legacy API的注册</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">.</span><span class="token function">VersionEnabled</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		legacyRESTStorageProvider <span class="token operator">:=</span> corerest<span class="token punctuation">.</span>LegacyRESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// REST接口的存储定义，可以看到很多k8s上的常见定义，比如node节点/storage存储/event事件等等</span>
	restStorageProviders <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>RESTStorageProvider<span class="token punctuation">{</span>
		authenticationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authenticator<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> APIAudiences<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">}</span><span class="token punctuation">,</span>
		authorizationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authorizer<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> RuleResolver<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">}</span><span class="token punctuation">,</span>
		autoscalingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		batchrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		certificatesrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		coordinationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		discoveryrest<span class="token punctuation">.</span>StorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		extensionsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		networkingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		noderest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		policyrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		rbacrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authorizer<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">}</span><span class="token punctuation">,</span>
		schedulingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		settingsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		storagerest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		flowcontrolrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.</span>
		<span class="token comment">// See https://github.com/kubernetes/kubernetes/issues/42392</span>
		appsrest<span class="token punctuation">.</span>StorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		admissionregistrationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		eventsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>TTL<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>EventTTL<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 注册API</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// 添加Hook</span>
	m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHookOrDie</span><span class="token punctuation">(</span><span class="token string">"start-cluster-authentication-info-controller"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>hookContext genericapiserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div></template>
