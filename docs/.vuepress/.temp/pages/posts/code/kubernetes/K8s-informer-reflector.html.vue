<template><h1 id="k8s-informer-reflector源码" tabindex="-1"><a class="header-anchor" href="#k8s-informer-reflector源码" aria-hidden="true">#</a> K8s-informer-reflector源码</h1>
<h2 id="作用说明" tabindex="-1"><a class="header-anchor" href="#作用说明" aria-hidden="true">#</a> 作用说明</h2>
<p>Reflector 用于监控（Watch）指定的 Kubernetes 资源，当监控的资源发生变化时，触发相应的变更事件，例如 Add 事件、Update 事件、Delete 事件，并将其资源对象存放到本地缓存 DeltaFIFO 中。</p>
<h2 id="结构说明" tabindex="-1"><a class="header-anchor" href="#结构说明" aria-hidden="true">#</a> 结构说明</h2>
<h3 id="reflector" tabindex="-1"><a class="header-anchor" href="#reflector" aria-hidden="true">#</a> Reflector</h3>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>
<span class="token comment">// Reflector(反射器) 监听指定的资源，将所有的变化都反射到给定的存储中去(store 对象)</span>
<span class="token keyword">type</span> Reflector <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// 反射器名称</span>
	name <span class="token builtin">string</span>
  <span class="token comment">// 期望放到 Store 中的类型名称，如果提供，则是 expectedGVK 的字符串形式</span>
  <span class="token comment">// 否则就是 expectedType 的字符串，它仅仅用于显示，不用于解析或者比较。</span>
	expectedTypeName <span class="token builtin">string</span>
	<span class="token comment">// 我们放到 Store 中的对象类型</span>
	expectedType reflect<span class="token punctuation">.</span>Type
	<span class="token comment">// 如果是非结构化的，我们期望放在 Sotre 中的对象的 GVK</span>
	expectedGVK <span class="token operator">*</span>schema<span class="token punctuation">.</span>GroupVersionKind
	<span class="token comment">// 与 watch 源同步的目标 Store（FIFO）</span>
	store Store
	<span class="token comment">// 用来执行 lists 和 watches 操作的 listerWatcher 接口（最重要的）</span>
	listerWatcher ListerWatcher
	backoffManager wait<span class="token punctuation">.</span>BackoffManager
	initConnBackoffManager wait<span class="token punctuation">.</span>BackoffManager
	resyncPeriod time<span class="token punctuation">.</span>Duration
	<span class="token comment">// ShouldResync 会周期性的被调用，当返回 true 的时候，就会调用 Store 的 Resync 操作</span>
	ShouldResync <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	clock clock<span class="token punctuation">.</span>Clock
	paginatedResult <span class="token builtin">bool</span>
	<span class="token comment">// 对象的任何修改(添加、删除、更新)都会造成资源版本更新，lastSyncResourceVersion 就是指的这个版本的版本号</span>
	lastSyncResourceVersion <span class="token builtin">string</span>
	<span class="token comment">// 如果之前的 list 或 watch 带有 lastSyncResourceVersion 的请求中是一个 HTTP 410（Gone）的失败请求，则 isLastSyncResourceVersionGone 为 true</span>
	isLastSyncResourceVersionUnavailable <span class="token builtin">bool</span>
	lastSyncResourceVersionMutex sync<span class="token punctuation">.</span>RWMutex
	WatchListPageSize <span class="token builtin">int64</span>
	watchErrorHandler WatchErrorHandler
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="listerwatcher" tabindex="-1"><a class="header-anchor" href="#listerwatcher" aria-hidden="true">#</a> ListerWatcher</h3>
<p>必须传入一个 ListerWatcher 接口对象，这个也是反射器最核心的功能，该接口拥有 List 和 Watch 方法，用于获取和监控资源对象。</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/listwatch.go</span>
<span class="token comment">// Lister 是知道如何执行初始化List列表的对象</span>
<span class="token keyword">type</span> Lister <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// List 应该返回一个列表类型的对象；</span>
  <span class="token comment">// Items 字段将被解析，ResourceVersion 字段将被用于正确启动 watch 的地方</span>
	<span class="token function">List</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Watcher 是知道如何执行 watch 操作的任何对象</span>
<span class="token keyword">type</span> Watcher <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Watch 在指定的版本开始执行 watch 操作</span>
	<span class="token function">Watch</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ListerWatcher 是任何知道如何对一个资源执行初始化List列表和启动Watch监控操作的对象</span>
<span class="token keyword">type</span> ListerWatcher <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Lister
	Watcher
<span class="token punctuation">}</span>



<span class="token comment">// k8s.io/client-go/informers/apps/v1/deployment.go</span>
<span class="token comment">// Deployment的ListWatch 功能</span>
<span class="token keyword">func</span> <span class="token function">NewFilteredDeploymentInformer</span><span class="token punctuation">(</span>client kubernetes<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> namespace <span class="token builtin">string</span><span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> indexers cache<span class="token punctuation">.</span>Indexers<span class="token punctuation">,</span> tweakListOptions internalinterfaces<span class="token punctuation">.</span>TweakListOptionsFunc<span class="token punctuation">)</span> cache<span class="token punctuation">.</span>SharedIndexInformer <span class="token punctuation">{</span>
	<span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">NewSharedIndexInformer</span><span class="token punctuation">(</span>
		<span class="token operator">&amp;</span>cache<span class="token punctuation">.</span>ListWatch<span class="token punctuation">{</span>
			ListFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> tweakListOptions <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token function">tweakListOptions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">AppsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			WatchFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> tweakListOptions <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token function">tweakListOptions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">AppsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		resyncPeriod<span class="token punctuation">,</span>
		indexers<span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="执行流程" tabindex="-1"><a class="header-anchor" href="#执行流程" aria-hidden="true">#</a> 执行流程</h2>
<p>开完关键核心代码之后 我们再来看看Reflector的启动过程</p>
<h3 id="run" tabindex="-1"><a class="header-anchor" href="#run" aria-hidden="true">#</a> run</h3>
<p>核心是执行 ListAndWatch 方法</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>

<span class="token comment">// Run 函数反复使用反射器的 ListAndWatch 函数来获取所有对象和后续的 deltas。</span>
<span class="token comment">// 当 stopCh 被关闭的时候，Run函数才会退出。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Reflector<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Starting reflector %s (%s) from %s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resyncPeriod<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	wait<span class="token punctuation">.</span><span class="token function">BackoffUntil</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">ListAndWatch</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>backoffManager<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Stopping reflector %s (%s) from %s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resyncPeriod<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="listandwatch" tabindex="-1"><a class="header-anchor" href="#listandwatch" aria-hidden="true">#</a> ListAndWatch</h3>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>

<span class="token comment">//ListAndWatch首先列出所有项，并在调用时获取资源版本，然后使用资源版本进行监视。如果ListAndWatch没有尝试初始化watch，它会返回错误。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Reflector<span class="token punctuation">)</span> <span class="token function">ListAndWatch</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Listing and watching %v from %s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token keyword">var</span> resourceVersion <span class="token builtin">string</span>

	options <span class="token operator">:=</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>ResourceVersion<span class="token punctuation">:</span> r<span class="token punctuation">.</span><span class="token function">relistResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		initTrace <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Reflector ListAndWatch"</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span>Field<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> r<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> initTrace<span class="token punctuation">.</span><span class="token function">LogIfLong</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token keyword">var</span> list runtime<span class="token punctuation">.</span>Object
		<span class="token keyword">var</span> paginatedResult <span class="token builtin">bool</span>
		<span class="token keyword">var</span> err <span class="token builtin">error</span>
		listCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		panicCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    
    <span class="token comment">// 执行list操作</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					panicCh <span class="token operator">&lt;-</span> r
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// 调用list接口 执行list的分页查询</span>
			pager <span class="token operator">:=</span> pager<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>pager<span class="token punctuation">.</span><span class="token function">SimplePageFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>opts metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> r<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">switch</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> r<span class="token punctuation">.</span>WatchListPageSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
				pager<span class="token punctuation">.</span>PageSize <span class="token operator">=</span> r<span class="token punctuation">.</span>WatchListPageSize
			<span class="token keyword">case</span> r<span class="token punctuation">.</span>paginatedResult<span class="token punctuation">:</span>
				<span class="token comment">//  // 获得一个初始的分页结果。假定此资源和服务器符合分页请求，并保留默认的分页器大小设置</span>
			<span class="token keyword">case</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">!=</span> <span class="token string">"0"</span><span class="token punctuation">:</span>
				pager<span class="token punctuation">.</span>PageSize <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">}</span>

			list<span class="token punctuation">,</span> paginatedResult<span class="token punctuation">,</span> err <span class="token operator">=</span> pager<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">isExpiredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isTooLargeResourceVersionError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				r<span class="token punctuation">.</span><span class="token function">setIsLastSyncResourceVersionUnavailable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
				list<span class="token punctuation">,</span> paginatedResult<span class="token punctuation">,</span> err <span class="token operator">=</span> pager<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>ResourceVersion<span class="token punctuation">:</span> r<span class="token punctuation">.</span><span class="token function">relistResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token function">close</span><span class="token punctuation">(</span>listCh<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token keyword">case</span> r <span class="token operator">:=</span> <span class="token operator">&lt;-</span>panicCh<span class="token punctuation">:</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>listCh<span class="token punctuation">:</span>
		<span class="token punctuation">}</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Objects listed"</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span>Field<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> err<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"%s: failed to list %v: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to list %v: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">==</span> <span class="token string">"0"</span> <span class="token operator">&amp;&amp;</span> paginatedResult <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>paginatedResult <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>

		r<span class="token punctuation">.</span><span class="token function">setIsLastSyncResourceVersionUnavailable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// list 成功</span>
		listMetaInterface<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ListAccessor</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to understand list result %#v: %v"</span><span class="token punctuation">,</span> list<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		resourceVersion <span class="token operator">=</span> listMetaInterface<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Resource version extracted"</span><span class="token punctuation">)</span>
		items<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to understand list result %#v (%v)"</span><span class="token punctuation">,</span> list<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Objects extracted"</span><span class="token punctuation">)</span>
    <span class="token comment">// 这一步会把list出来的数据  Replace 到store中</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">syncWith</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> resourceVersion<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to sync list result: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"SyncWith done"</span><span class="token punctuation">)</span>
		r<span class="token punctuation">.</span><span class="token function">setLastSyncResourceVersion</span><span class="token punctuation">(</span>resourceVersion<span class="token punctuation">)</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Resource version updated"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	resyncerrc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	cancelCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>cancelCh<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		resyncCh<span class="token punctuation">,</span> cleanup <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">resyncChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Call the last one written into cleanup</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>resyncCh<span class="token punctuation">:</span>
       <span class="token comment">//  stopCh 一个停止循环的机会</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>cancelCh<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>ShouldResync <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> r<span class="token punctuation">.</span><span class="token function">ShouldResync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"%s: forcing resync"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					resyncerrc <span class="token operator">&lt;-</span> err
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			resyncCh<span class="token punctuation">,</span> cleanup <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">resyncChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  
  <span class="token comment">// watch操作</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// give the stopCh a chance to stop the loop, even in case of continue statements further down on errors</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token punctuation">}</span>

		timeoutSeconds <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>minWatchTimeout<span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Float64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置watch的选项，因为前期列举了全量对象，从这里只要监听最新版本以后的资源就可以了 并且设置超时时间</span>
		options <span class="token operator">=</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>
			ResourceVersion<span class="token punctuation">:</span> resourceVersion<span class="token punctuation">,</span>
			TimeoutSeconds<span class="token punctuation">:</span> <span class="token operator">&amp;</span>timeoutSeconds<span class="token punctuation">,</span>
			AllowWatchBookmarks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>

		start <span class="token operator">:=</span> r<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 调用 Watch 接口 执行Watch 操作</span>
		w<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> utilnet<span class="token punctuation">.</span><span class="token function">IsConnectionRefused</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> apierrors<span class="token punctuation">.</span><span class="token function">IsTooManyRequests</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>initConnBackoffManager<span class="token punctuation">.</span><span class="token function">Backoff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>

    <span class="token comment">// 执行 watchHandler 操作</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">watchHandler</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resourceVersion<span class="token punctuation">,</span> resyncerrc<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> errorStopRequested <span class="token punctuation">{</span>
				<span class="token keyword">switch</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> <span class="token function">isExpiredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">:</span>
					klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"%s: watch of %v closed with: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">case</span> apierrors<span class="token punctuation">.</span><span class="token function">IsTooManyRequests</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">:</span>
					klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"%s: watch of %v returned 429 - backing off"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">)</span>
					<span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>initConnBackoffManager<span class="token punctuation">.</span><span class="token function">Backoff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
					klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"%s: watch of %v ended with: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br></div></div><h3 id="watchhandler" tabindex="-1"><a class="header-anchor" href="#watchhandler" aria-hidden="true">#</a> watchHandler</h3>
<p>在执行watch操作时 最后会执行一个watchHandler 对不同的事件 执行不同的处理方式</p>
<p>对于增删改操作 都会调用底层的Store对应的方法</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>

<span class="token comment">// watchHandler 监听 w 保持资源版本最新</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Reflector<span class="token punctuation">)</span> <span class="token function">watchHandler</span><span class="token punctuation">(</span>start time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> w watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> resourceVersion <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">,</span> errc <span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	eventCount <span class="token operator">:=</span> <span class="token number">0</span>

	<span class="token keyword">defer</span> w<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

loop<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> errorStopRequested
		<span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errc<span class="token punctuation">:</span>
			<span class="token keyword">return</span> err
		<span class="token keyword">case</span> event<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span><span class="token function">ResultChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
				<span class="token keyword">break</span> loop
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> event<span class="token punctuation">.</span>Type <span class="token operator">==</span> watch<span class="token punctuation">.</span>Error <span class="token punctuation">{</span>
				<span class="token keyword">return</span> apierrors<span class="token punctuation">.</span><span class="token function">FromObject</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>expectedType <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> e<span class="token punctuation">,</span> a <span class="token operator">:=</span> r<span class="token punctuation">.</span>expectedType<span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> a <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: expected type %v, but watch event object had type %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>expectedGVK <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> e<span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token operator">*</span>r<span class="token punctuation">.</span>expectedGVK<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token function">GetObjectKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupVersionKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> a <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: expected gvk %v, but watch event object had gvk %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			meta<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">Accessor</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: unable to understand watch event %#v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// 获取当前watch到的资源版本号</span>
			newResourceVersion <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">switch</span> event<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>  <span class="token comment">// 分发事件</span>
			<span class="token keyword">case</span> watch<span class="token punctuation">.</span>Added<span class="token punctuation">:</span>    <span class="token comment">// add事件</span>
				err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: unable to add watch event object (%#v) to store: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> watch<span class="token punctuation">.</span>Modified<span class="token punctuation">:</span> <span class="token comment">// Update 事件</span>
				err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: unable to update watch event object (%#v) to store: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> watch<span class="token punctuation">.</span>Deleted<span class="token punctuation">:</span> <span class="token comment">// Delete 事件</span>
				err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: unable to delete watch event object (%#v) from store: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> watch<span class="token punctuation">.</span>Bookmark<span class="token punctuation">:</span>
				<span class="token comment">// A `Bookmark` means watch has synced here, just update the resourceVersion</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: unable to understand watch event %#v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token operator">*</span>resourceVersion <span class="token operator">=</span> newResourceVersion
			r<span class="token punctuation">.</span><span class="token function">setLastSyncResourceVersion</span><span class="token punctuation">(</span>newResourceVersion<span class="token punctuation">)</span>
			<span class="token keyword">if</span> rvu<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token punctuation">(</span>ResourceVersionUpdater<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				rvu<span class="token punctuation">.</span><span class="token function">UpdateResourceVersion</span><span class="token punctuation">(</span>newResourceVersion<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			eventCount<span class="token operator">++</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	watchDuration <span class="token operator">:=</span> r<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
	<span class="token keyword">if</span> watchDuration <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token operator">&amp;&amp;</span> eventCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"very short watch: %s: Unexpected watch close - watch lasted less than a second and no items received"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"%s: Watch close - %v total %v items received"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> eventCount<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div></template>
