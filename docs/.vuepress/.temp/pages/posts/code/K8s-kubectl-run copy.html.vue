<template><h1 id="kubectl源码解读" tabindex="-1"><a class="header-anchor" href="#kubectl源码解读" aria-hidden="true">#</a> kubectl源码解读</h1>
<h2 id="kubectl-入口函数" tabindex="-1"><a class="header-anchor" href="#kubectl-入口函数" aria-hidden="true">#</a> kubectl 入口函数</h2>
<p>cmd/kubectl/kubectl.go</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 如果不调用rand.Seed，每次重新运行这个main函数，rand下的函数返回值始终一致</span>
	<span class="token comment">// Seed即随机的种子，每次用时间戳作为种子，就能保证随机性</span>
	rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


	<span class="token comment">// 创建了kubectl命令的默认参数</span>
	command <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">NewDefaultKubectlCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">SetNormalizeFunc</span><span class="token punctuation">(</span>cliflag<span class="token punctuation">.</span>WordSepNormalizeFunc<span class="token punctuation">)</span>
	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">AddGoFlagSet</span><span class="token punctuation">(</span>goflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>
	<span class="token comment">//  初始化log</span>
	logs<span class="token punctuation">.</span><span class="token function">InitLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> logs<span class="token punctuation">.</span><span class="token function">FlushLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
	<span class="token comment">// 运行command 运行上述步骤的流程</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>该部分最重要的是NewDefaultKubectlCommand() 接下来我们看一看这个函数具体内容</p>
<h2 id="newdefaultkubectlcommand-主函数的执行流程" tabindex="-1"><a class="header-anchor" href="#newdefaultkubectlcommand-主函数的执行流程" aria-hidden="true">#</a> NewDefaultKubectlCommand() -主函数的执行流程</h2>
<p><strong>该函数主要是 初始化Command对象 再将传入的参数解析使用Command对象执行</strong></p>
<p>主要流程为
1 调用NewDefaultKubectlCommandWithArgs
2 NewKubectlCommand(in, out, errout) 采用标准输入、输出、错误输出初始化Command对象
3 处理传入的参数将参数传入第一步的Command对象进行执行</p>
<p>pkg/kubectl/cmd/cmd.go</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// 创建初始化的kubect</span>
<span class="token comment">//  k8s的命令行工具采用了 cobra 库，具有命令提示等强大功能，比go语言自带的flag强大很多，可参考 github.com/spf13/cobra</span>
<span class="token keyword">func</span> <span class="token function">NewDefaultKubectlCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">NewDefaultKubectlCommandWithArgs</span><span class="token punctuation">(</span><span class="token function">NewDefaultPluginHandler</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>ValidPluginFilenamePrefixes<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stdin<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stderr<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>该函数调用 NewDefaultKubectlCommandWithArgs 并且将参数传入</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// NewDefaultKubectlCommandWithArgs creates the `kubectl` command with arguments</span>
<span class="token keyword">func</span> <span class="token function">NewDefaultKubectlCommandWithArgs</span><span class="token punctuation">(</span>pluginHandler PluginHandler<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> in io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> out<span class="token punctuation">,</span> errout io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
   <span class="token comment">// 初始化NewKubectlCommand，采用标准输入、输出、错误输出</span>
   cmd <span class="token operator">:=</span> <span class="token function">NewKubectlCommand</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> errout<span class="token punctuation">)</span>

   <span class="token keyword">if</span> pluginHandler <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cmd
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里为传入的参数，即 create -f nginx_pod.yaml 部分</span>
      cmdPathPieces <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

      <span class="token comment">//  调用cobra的Find去匹配args</span>
      <span class="token comment">// 如果指定的命令不存在，则只寻找合适的扩展可执行文件</span>
      <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>cmdPathPieces<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">HandlePluginCommand</span><span class="token punctuation">(</span>pluginHandler<span class="token punctuation">,</span> cmdPathPieces<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>errout<span class="token punctuation">,</span> <span class="token string">"%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> cmd
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="newkubectlcommand-命令command对象的创建" tabindex="-1"><a class="header-anchor" href="#newkubectlcommand-命令command对象的创建" aria-hidden="true">#</a> NewKubectlCommand() - 命令command对象的创建</h2>
<p><strong>在上一步我们已经知道了大致的处理过程，接下来我们看看Command到底是怎么创建的也就是NewKubectlCommand（）函数的细节</strong></p>
<p>主要流程为
1 初始化command的主命令 并且注入一些执行前 执行后的hook函数
2 cmd以配置文件进行实例化
3 初始化一个工场类
4 注入子命令 例如create delete等
5 处理alpha命令
6 代码补全
7 将相关组件注入command对象并且返回</p>
<p>pkg/kubectl/cmd/cmd.go</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewKubectlCommand</span><span class="token punctuation">(</span>in io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> out<span class="token punctuation">,</span> err io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
   <span class="token comment">// 添加所有子命令的父命令。</span>
   <span class="token comment">// 创建主命令</span>
   cmds <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
      Use<span class="token punctuation">:</span>   <span class="token string">"kubectl"</span><span class="token punctuation">,</span>
      Short<span class="token punctuation">:</span> i18n<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token string">"kubectl controls the Kubernetes cluster manager"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Long<span class="token punctuation">:</span> templates<span class="token punctuation">.</span><span class="token function">LongDesc</span><span class="token punctuation">(</span><span class="token string">`
      kubectl controls the Kubernetes cluster manager.
      
      Find more information at:
            https://kubernetes.io/docs/reference/kubectl/overview/`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Run<span class="token punctuation">:</span> runHelp<span class="token punctuation">,</span>
      <span class="token comment">// 初始化后，在运行指令前的钩子</span>
      PersistentPreRunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里是做pprof性能分析，跳转到对应代码可以看到，我们可以用参数 --profile xxx 来采集性能指标，默认保存在当前目录下的profile.pprof中</span>
         <span class="token keyword">return</span> <span class="token function">initProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 运行指令后的钩子</span>
      PersistentPostRunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">flushProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">//bash自动补齐功能，可通过 kubectl completion bash 命令查看</span>
      <span class="token comment">//具体安装可参考 https://kubernetes.io/docs/tasks/tools/install-kubectl/#enabling-shell-autocompletion</span>
      BashCompletionFunction<span class="token punctuation">:</span> bashCompletionFunc<span class="token punctuation">,</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// cmd实例化的过程</span>
   flags <span class="token operator">:=</span> cmds<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   flags<span class="token punctuation">.</span><span class="token function">SetNormalizeFunc</span><span class="token punctuation">(</span>cliflag<span class="token punctuation">.</span>WarnWordSepNormalizeFunc<span class="token punctuation">)</span> <span class="token comment">// Warn for "_" flags</span>

   <span class="token comment">// Normalize all flags that are coming from other packages or pre-configurations</span>
   <span class="token comment">// a.k.a. change all "_" to "-". e.g. glog package</span>
   flags<span class="token punctuation">.</span><span class="token function">SetNormalizeFunc</span><span class="token punctuation">(</span>cliflag<span class="token punctuation">.</span>WordSepNormalizeFunc<span class="token punctuation">)</span>

   <span class="token function">addProfilingFlags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span>

   kubeConfigFlags <span class="token operator">:=</span> genericclioptions<span class="token punctuation">.</span><span class="token function">NewConfigFlags</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithDeprecatedPasswordFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   kubeConfigFlags<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span>
   matchVersionKubeConfigFlags <span class="token operator">:=</span> cmdutil<span class="token punctuation">.</span><span class="token function">NewMatchVersionFlags</span><span class="token punctuation">(</span>kubeConfigFlags<span class="token punctuation">)</span>
   matchVersionKubeConfigFlags<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>cmds<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

   cmds<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddGoFlagSet</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>


   <span class="token comment">// 初始化了一个工厂</span>
   f <span class="token operator">:=</span> cmdutil<span class="token punctuation">.</span><span class="token function">NewFactory</span><span class="token punctuation">(</span>matchVersionKubeConfigFlags<span class="token punctuation">)</span>

   i18n<span class="token punctuation">.</span><span class="token function">LoadTranslations</span><span class="token punctuation">(</span><span class="token string">"kubectl"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
   cmds<span class="token punctuation">.</span><span class="token function">SetGlobalNormalizationFunc</span><span class="token punctuation">(</span>cliflag<span class="token punctuation">.</span>WarnWordSepNormalizeFunc<span class="token punctuation">)</span>
   ioStreams <span class="token operator">:=</span> genericclioptions<span class="token punctuation">.</span>IOStreams<span class="token punctuation">{</span>In<span class="token punctuation">:</span> in<span class="token punctuation">,</span> Out<span class="token punctuation">:</span> out<span class="token punctuation">,</span> ErrOut<span class="token punctuation">:</span> err<span class="token punctuation">}</span>

   <span class="token comment">//    kubectl定义了7类命令，结合Message和各个子命令的package名来看</span>
   groups <span class="token operator">:=</span> templates<span class="token punctuation">.</span>CommandGroups<span class="token punctuation">{</span>
      <span class="token punctuation">{</span>
         Message<span class="token punctuation">:</span> <span class="token string">"Basic Commands (Beginner):"</span><span class="token punctuation">,</span>
         Commands<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
            create<span class="token punctuation">.</span><span class="token function">NewCmdCreate</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>
            expose<span class="token punctuation">.</span><span class="token function">NewCmdExposeService</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>
            run<span class="token punctuation">.</span><span class="token function">NewCmdRun</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>
            set<span class="token punctuation">.</span><span class="token function">NewCmdSet</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 其他命令省略。。。。。。</span>
   <span class="token punctuation">}</span>
   groups<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span>

   filters <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"options"</span><span class="token punctuation">}</span>

   <span class="token comment">// 如果在这个版本中没有alpha命令，隐藏“alpha”子命令。</span>
   <span class="token comment">// alpha相关的子命令</span>
   alpha <span class="token operator">:=</span> cmdpkg<span class="token punctuation">.</span><span class="token function">NewCmdAlpha</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token operator">!</span>alpha<span class="token punctuation">.</span><span class="token function">HasSubCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      filters <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>filters<span class="token punctuation">,</span> alpha<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   templates<span class="token punctuation">.</span><span class="token function">ActsAsRootCommand</span><span class="token punctuation">(</span>cmds<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> groups<span class="token operator">...</span><span class="token punctuation">)</span>

   <span class="token comment">// // 代码补全相关</span>
   <span class="token keyword">for</span> name<span class="token punctuation">,</span> completion <span class="token operator">:=</span> <span class="token keyword">range</span> bashCompletionFlags <span class="token punctuation">{</span>
      <span class="token keyword">if</span> cmds<span class="token punctuation">.</span><span class="token function">Flag</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> cmds<span class="token punctuation">.</span><span class="token function">Flag</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>Annotations <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            cmds<span class="token punctuation">.</span><span class="token function">Flag</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>Annotations <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         cmds<span class="token punctuation">.</span><span class="token function">Flag</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>Annotations<span class="token punctuation">[</span>cobra<span class="token punctuation">.</span>BashCompCustom<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>
            cmds<span class="token punctuation">.</span><span class="token function">Flag</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>Annotations<span class="token punctuation">[</span>cobra<span class="token punctuation">.</span>BashCompCustom<span class="token punctuation">]</span><span class="token punctuation">,</span>
            completion<span class="token punctuation">,</span>
         <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 添加其余子命令，包括 alpha/config/plugin/version/api-versions/api-resources/options</span>
   cmds<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>alpha<span class="token punctuation">)</span>
   cmds<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>cmdconfig<span class="token punctuation">.</span><span class="token function">NewCmdConfig</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> clientcmd<span class="token punctuation">.</span><span class="token function">NewDefaultPathOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmds<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token function">NewCmdPlugin</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmds<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>version<span class="token punctuation">.</span><span class="token function">NewCmdVersion</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmds<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>apiresources<span class="token punctuation">.</span><span class="token function">NewCmdAPIVersions</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmds<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>apiresources<span class="token punctuation">.</span><span class="token function">NewCmdAPIResources</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmds<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">NewCmdOptions</span><span class="token punctuation">(</span>ioStreams<span class="token punctuation">.</span>Out<span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token keyword">return</span> cmds
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><h2 id="newcmdcreate-create命令详解" tabindex="-1"><a class="header-anchor" href="#newcmdcreate-create命令详解" aria-hidden="true">#</a> NewCmdCreate() - create命令详解</h2>
<p><strong>在上面一段中我们了解了，k8s的命令是分组的注入在代码中，我们就来详细看看与create相关的create.NewCmdCreate函数</strong></p>
<p>主要流程为
1 初始化 create子命令的相关选项
2 验证参数并运行
3 RunCreate
4 create的子命令，指定create对象
5 将相关组件注入command对象并且返回</p>
<p>k8s.io/kubectl/pkg/cmd/create/create.go</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewCmdCreate</span><span class="token punctuation">(</span>f cmdutil<span class="token punctuation">.</span>Factory<span class="token punctuation">,</span> ioStreams genericclioptions<span class="token punctuation">.</span>IOStreams<span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
   <span class="token comment">// create子命令的相关选项</span>
   o <span class="token operator">:=</span> <span class="token function">NewCreateOptions</span><span class="token punctuation">(</span>ioStreams<span class="token punctuation">)</span>
   <span class="token comment">// create子命令的相关说明</span>
   cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
      Use<span class="token punctuation">:</span>                   <span class="token string">"create -f FILENAME"</span><span class="token punctuation">,</span>
      DisableFlagsInUseLine<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      Short<span class="token punctuation">:</span>                 i18n<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token string">"Create a resource from a file or from stdin."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Long<span class="token punctuation">:</span>                  createLong<span class="token punctuation">,</span>
      Example<span class="token punctuation">:</span>               createExample<span class="token punctuation">,</span>
      <span class="token comment">// 验证参数并运行</span>
      Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> cmdutil<span class="token punctuation">.</span><span class="token function">IsFilenameSliceEmpty</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>FilenameOptions<span class="token punctuation">.</span>Filenames<span class="token punctuation">,</span> o<span class="token punctuation">.</span>FilenameOptions<span class="token punctuation">.</span>Kustomize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ioStreams<span class="token punctuation">.</span>ErrOut<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"Error: must specify one of -f and -k\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            defaultRunFunc <span class="token operator">:=</span> cmdutil<span class="token punctuation">.</span><span class="token function">DefaultSubCommandRun</span><span class="token punctuation">(</span>ioStreams<span class="token punctuation">.</span>ErrOut<span class="token punctuation">)</span>
            <span class="token function">defaultRunFunc</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
         <span class="token punctuation">}</span>
         cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
         cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">ValidateArgs</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token comment">// 核心的运行代码逻辑是在这里的RunCreate</span>
         cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">RunCreate</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// bind flag structs</span>
   o<span class="token punctuation">.</span>RecordFlags<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>

   usage <span class="token operator">:=</span> <span class="token string">"to use to create the resource"</span>
   <span class="token comment">// 加入文件名选项的flag -f，保存到o.FilenameOptions.Filenames中，对应上面</span>
   cmdutil<span class="token punctuation">.</span><span class="token function">AddFilenameOptionFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>o<span class="token punctuation">.</span>FilenameOptions<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
   cmdutil<span class="token punctuation">.</span><span class="token function">AddValidateFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">.</span>EditBeforeCreate<span class="token punctuation">,</span> <span class="token string">"edit"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>EditBeforeCreate<span class="token punctuation">,</span> <span class="token string">"Edit the API resource before creating"</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">"windows-line-endings"</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span>GOOS <span class="token operator">==</span> <span class="token string">"windows"</span><span class="token punctuation">,</span>
      <span class="token string">"Only relevant if --edit=true. Defaults to the line ending native to your platform."</span><span class="token punctuation">)</span>
   cmdutil<span class="token punctuation">.</span><span class="token function">AddApplyAnnotationFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
   cmdutil<span class="token punctuation">.</span><span class="token function">AddDryRunFlag</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> <span class="token string">"selector"</span><span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> <span class="token string">"Selector (label query) to filter on, supports '=', '==', and '!='.(e.g. -l key1=value1,key2=value2)"</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">.</span>Raw<span class="token punctuation">,</span> <span class="token string">"raw"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>Raw<span class="token punctuation">,</span> <span class="token string">"Raw URI to POST to the server.  Uses the transport specified by the kubeconfig file."</span><span class="token punctuation">)</span>

   o<span class="token punctuation">.</span>PrintFlags<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>

   <span class="token comment">// create的子命令，指定create对象</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateNamespace</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateQuota</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateSecret</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateConfigMap</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateServiceAccount</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateService</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateDeployment</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateClusterRole</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateClusterRoleBinding</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateRole</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateRoleBinding</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreatePodDisruptionBudget</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreatePriorityClass</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateJob</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateCronJob</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> cmd
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h2 id="runcreate-create的执行" tabindex="-1"><a class="header-anchor" href="#runcreate-create的执行" aria-hidden="true">#</a> RunCreate() -create的执行</h2>
<p>在上述我们知道了 create的创建过程，真正执行是RunCreate 我们就来看看RunCreate</p>
<p>主要流程为
1 初始化 工厂类
2 初始化builder
3 利用观察者模式处理资源创建  封装client 和object  发送给apiserver</p>
<p>pkg/kubectl/cmd/cmd.go</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>CreateOptions<span class="token punctuation">)</span> <span class="token function">RunCreate</span><span class="token punctuation">(</span>f cmdutil<span class="token punctuation">.</span>Factory<span class="token punctuation">,</span> cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// f为传入的Factory，主要是封装了与kube-apiserver交互客户端</span>
  
	schema<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Validator</span><span class="token punctuation">(</span>cmdutil<span class="token punctuation">.</span><span class="token function">GetFlagBool</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"validate"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	cmdNamespace<span class="token punctuation">,</span> enforceNamespace<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">ToRawKubeConfigLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

  <span class="token comment">// 实例化Builder，这块的逻辑比较复杂，我们先关注文件部分</span>
	r <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Unstructured</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Schema</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">ContinueOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">NamespaceParam</span><span class="token punctuation">(</span>cmdNamespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
  	<span class="token comment">// 读取文件信息，发现除了支持简单的本地文件，也支持标准输入和http/https协议访问的文件，保存为Visitor</span>
		<span class="token function">FilenameParam</span><span class="token punctuation">(</span>enforceNamespace<span class="token punctuation">,</span> <span class="token operator">&amp;</span>o<span class="token punctuation">.</span>FilenameOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">LabelSelectorParam</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	count <span class="token operator">:=</span> <span class="token number">0</span>
  <span class="token comment">// 调用visit函数，创建资源</span>
	err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>resource<span class="token punctuation">.</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">// 打印结果 xxxx created</span>
		<span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">PrintObj</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div></template>
