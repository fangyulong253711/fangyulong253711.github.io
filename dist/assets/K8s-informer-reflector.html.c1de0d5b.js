import{_ as n,e as s}from"./app.4b919133.js";const a={},t=s(`<h1 id="k8s-informer-reflector\u6E90\u7801" tabindex="-1"><a class="header-anchor" href="#k8s-informer-reflector\u6E90\u7801" aria-hidden="true">#</a> K8s-informer-reflector\u6E90\u7801</h1><h2 id="\u4F5C\u7528\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#\u4F5C\u7528\u8BF4\u660E" aria-hidden="true">#</a> \u4F5C\u7528\u8BF4\u660E</h2><p>Reflector \u7528\u4E8E\u76D1\u63A7\uFF08Watch\uFF09\u6307\u5B9A\u7684 Kubernetes \u8D44\u6E90\uFF0C\u5F53\u76D1\u63A7\u7684\u8D44\u6E90\u53D1\u751F\u53D8\u5316\u65F6\uFF0C\u89E6\u53D1\u76F8\u5E94\u7684\u53D8\u66F4\u4E8B\u4EF6\uFF0C\u4F8B\u5982 Add \u4E8B\u4EF6\u3001Update \u4E8B\u4EF6\u3001Delete \u4E8B\u4EF6\uFF0C\u5E76\u5C06\u5176\u8D44\u6E90\u5BF9\u8C61\u5B58\u653E\u5230\u672C\u5730\u7F13\u5B58 DeltaFIFO \u4E2D\u3002</p><h2 id="\u7ED3\u6784\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#\u7ED3\u6784\u8BF4\u660E" aria-hidden="true">#</a> \u7ED3\u6784\u8BF4\u660E</h2><h3 id="reflector" tabindex="-1"><a class="header-anchor" href="#reflector" aria-hidden="true">#</a> Reflector</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>
<span class="token comment">// Reflector(\u53CD\u5C04\u5668) \u76D1\u542C\u6307\u5B9A\u7684\u8D44\u6E90\uFF0C\u5C06\u6240\u6709\u7684\u53D8\u5316\u90FD\u53CD\u5C04\u5230\u7ED9\u5B9A\u7684\u5B58\u50A8\u4E2D\u53BB(store \u5BF9\u8C61)</span>
<span class="token keyword">type</span> Reflector <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// \u53CD\u5C04\u5668\u540D\u79F0</span>
	name <span class="token builtin">string</span>
  <span class="token comment">// \u671F\u671B\u653E\u5230 Store \u4E2D\u7684\u7C7B\u578B\u540D\u79F0\uFF0C\u5982\u679C\u63D0\u4F9B\uFF0C\u5219\u662F expectedGVK \u7684\u5B57\u7B26\u4E32\u5F62\u5F0F</span>
  <span class="token comment">// \u5426\u5219\u5C31\u662F expectedType \u7684\u5B57\u7B26\u4E32\uFF0C\u5B83\u4EC5\u4EC5\u7528\u4E8E\u663E\u793A\uFF0C\u4E0D\u7528\u4E8E\u89E3\u6790\u6216\u8005\u6BD4\u8F83\u3002</span>
	expectedTypeName <span class="token builtin">string</span>
	<span class="token comment">// \u6211\u4EEC\u653E\u5230 Store \u4E2D\u7684\u5BF9\u8C61\u7C7B\u578B</span>
	expectedType reflect<span class="token punctuation">.</span>Type
	<span class="token comment">// \u5982\u679C\u662F\u975E\u7ED3\u6784\u5316\u7684\uFF0C\u6211\u4EEC\u671F\u671B\u653E\u5728 Sotre \u4E2D\u7684\u5BF9\u8C61\u7684 GVK</span>
	expectedGVK <span class="token operator">*</span>schema<span class="token punctuation">.</span>GroupVersionKind
	<span class="token comment">// \u4E0E watch \u6E90\u540C\u6B65\u7684\u76EE\u6807 Store\uFF08FIFO\uFF09</span>
	store Store
	<span class="token comment">// \u7528\u6765\u6267\u884C lists \u548C watches \u64CD\u4F5C\u7684 listerWatcher \u63A5\u53E3\uFF08\u6700\u91CD\u8981\u7684\uFF09</span>
	listerWatcher ListerWatcher
	backoffManager wait<span class="token punctuation">.</span>BackoffManager
	initConnBackoffManager wait<span class="token punctuation">.</span>BackoffManager
	resyncPeriod time<span class="token punctuation">.</span>Duration
	<span class="token comment">// ShouldResync \u4F1A\u5468\u671F\u6027\u7684\u88AB\u8C03\u7528\uFF0C\u5F53\u8FD4\u56DE true \u7684\u65F6\u5019\uFF0C\u5C31\u4F1A\u8C03\u7528 Store \u7684 Resync \u64CD\u4F5C</span>
	ShouldResync <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	clock clock<span class="token punctuation">.</span>Clock
	paginatedResult <span class="token builtin">bool</span>
	<span class="token comment">// \u5BF9\u8C61\u7684\u4EFB\u4F55\u4FEE\u6539(\u6DFB\u52A0\u3001\u5220\u9664\u3001\u66F4\u65B0)\u90FD\u4F1A\u9020\u6210\u8D44\u6E90\u7248\u672C\u66F4\u65B0\uFF0ClastSyncResourceVersion \u5C31\u662F\u6307\u7684\u8FD9\u4E2A\u7248\u672C\u7684\u7248\u672C\u53F7</span>
	lastSyncResourceVersion <span class="token builtin">string</span>
	<span class="token comment">// \u5982\u679C\u4E4B\u524D\u7684 list \u6216 watch \u5E26\u6709 lastSyncResourceVersion \u7684\u8BF7\u6C42\u4E2D\u662F\u4E00\u4E2A HTTP 410\uFF08Gone\uFF09\u7684\u5931\u8D25\u8BF7\u6C42\uFF0C\u5219 isLastSyncResourceVersionGone \u4E3A true</span>
	isLastSyncResourceVersionUnavailable <span class="token builtin">bool</span>
	lastSyncResourceVersionMutex sync<span class="token punctuation">.</span>RWMutex
	WatchListPageSize <span class="token builtin">int64</span>
	watchErrorHandler WatchErrorHandler
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="listerwatcher" tabindex="-1"><a class="header-anchor" href="#listerwatcher" aria-hidden="true">#</a> ListerWatcher</h3><p>\u5FC5\u987B\u4F20\u5165\u4E00\u4E2A ListerWatcher \u63A5\u53E3\u5BF9\u8C61\uFF0C\u8FD9\u4E2A\u4E5F\u662F\u53CD\u5C04\u5668\u6700\u6838\u5FC3\u7684\u529F\u80FD\uFF0C\u8BE5\u63A5\u53E3\u62E5\u6709 List \u548C Watch \u65B9\u6CD5\uFF0C\u7528\u4E8E\u83B7\u53D6\u548C\u76D1\u63A7\u8D44\u6E90\u5BF9\u8C61\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/listwatch.go</span>
<span class="token comment">// Lister \u662F\u77E5\u9053\u5982\u4F55\u6267\u884C\u521D\u59CB\u5316List\u5217\u8868\u7684\u5BF9\u8C61</span>
<span class="token keyword">type</span> Lister <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// List \u5E94\u8BE5\u8FD4\u56DE\u4E00\u4E2A\u5217\u8868\u7C7B\u578B\u7684\u5BF9\u8C61\uFF1B</span>
  <span class="token comment">// Items \u5B57\u6BB5\u5C06\u88AB\u89E3\u6790\uFF0CResourceVersion \u5B57\u6BB5\u5C06\u88AB\u7528\u4E8E\u6B63\u786E\u542F\u52A8 watch \u7684\u5730\u65B9</span>
	<span class="token function">List</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Watcher \u662F\u77E5\u9053\u5982\u4F55\u6267\u884C watch \u64CD\u4F5C\u7684\u4EFB\u4F55\u5BF9\u8C61</span>
<span class="token keyword">type</span> Watcher <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Watch \u5728\u6307\u5B9A\u7684\u7248\u672C\u5F00\u59CB\u6267\u884C watch \u64CD\u4F5C</span>
	<span class="token function">Watch</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ListerWatcher \u662F\u4EFB\u4F55\u77E5\u9053\u5982\u4F55\u5BF9\u4E00\u4E2A\u8D44\u6E90\u6267\u884C\u521D\u59CB\u5316List\u5217\u8868\u548C\u542F\u52A8Watch\u76D1\u63A7\u64CD\u4F5C\u7684\u5BF9\u8C61</span>
<span class="token keyword">type</span> ListerWatcher <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Lister
	Watcher
<span class="token punctuation">}</span>



<span class="token comment">// k8s.io/client-go/informers/apps/v1/deployment.go</span>
<span class="token comment">// Deployment\u7684ListWatch \u529F\u80FD</span>
<span class="token keyword">func</span> <span class="token function">NewFilteredDeploymentInformer</span><span class="token punctuation">(</span>client kubernetes<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> namespace <span class="token builtin">string</span><span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> indexers cache<span class="token punctuation">.</span>Indexers<span class="token punctuation">,</span> tweakListOptions internalinterfaces<span class="token punctuation">.</span>TweakListOptionsFunc<span class="token punctuation">)</span> cache<span class="token punctuation">.</span>SharedIndexInformer <span class="token punctuation">{</span>
	<span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">NewSharedIndexInformer</span><span class="token punctuation">(</span>
		<span class="token operator">&amp;</span>cache<span class="token punctuation">.</span>ListWatch<span class="token punctuation">{</span>
			ListFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> tweakListOptions <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token function">tweakListOptions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">AppsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			WatchFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> tweakListOptions <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token function">tweakListOptions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">AppsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		resyncPeriod<span class="token punctuation">,</span>
		indexers<span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="\u6267\u884C\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u6267\u884C\u6D41\u7A0B" aria-hidden="true">#</a> \u6267\u884C\u6D41\u7A0B</h2><p>\u5F00\u5B8C\u5173\u952E\u6838\u5FC3\u4EE3\u7801\u4E4B\u540E \u6211\u4EEC\u518D\u6765\u770B\u770BReflector\u7684\u542F\u52A8\u8FC7\u7A0B</p><h3 id="run" tabindex="-1"><a class="header-anchor" href="#run" aria-hidden="true">#</a> run</h3><p>\u6838\u5FC3\u662F\u6267\u884C ListAndWatch \u65B9\u6CD5</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>

<span class="token comment">// Run \u51FD\u6570\u53CD\u590D\u4F7F\u7528\u53CD\u5C04\u5668\u7684 ListAndWatch \u51FD\u6570\u6765\u83B7\u53D6\u6240\u6709\u5BF9\u8C61\u548C\u540E\u7EED\u7684 deltas\u3002</span>
<span class="token comment">// \u5F53 stopCh \u88AB\u5173\u95ED\u7684\u65F6\u5019\uFF0CRun\u51FD\u6570\u624D\u4F1A\u9000\u51FA\u3002</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Reflector<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Starting reflector %s (%s) from %s&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resyncPeriod<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	wait<span class="token punctuation">.</span><span class="token function">BackoffUntil</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">ListAndWatch</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>backoffManager<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Stopping reflector %s (%s) from %s&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resyncPeriod<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="listandwatch" tabindex="-1"><a class="header-anchor" href="#listandwatch" aria-hidden="true">#</a> ListAndWatch</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>

<span class="token comment">//ListAndWatch\u9996\u5148\u5217\u51FA\u6240\u6709\u9879\uFF0C\u5E76\u5728\u8C03\u7528\u65F6\u83B7\u53D6\u8D44\u6E90\u7248\u672C\uFF0C\u7136\u540E\u4F7F\u7528\u8D44\u6E90\u7248\u672C\u8FDB\u884C\u76D1\u89C6\u3002\u5982\u679CListAndWatch\u6CA1\u6709\u5C1D\u8BD5\u521D\u59CB\u5316watch\uFF0C\u5B83\u4F1A\u8FD4\u56DE\u9519\u8BEF\u3002</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Reflector<span class="token punctuation">)</span> <span class="token function">ListAndWatch</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Listing and watching %v from %s&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token keyword">var</span> resourceVersion <span class="token builtin">string</span>

	options <span class="token operator">:=</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>ResourceVersion<span class="token punctuation">:</span> r<span class="token punctuation">.</span><span class="token function">relistResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		initTrace <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;Reflector ListAndWatch&quot;</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span>Field<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> r<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> initTrace<span class="token punctuation">.</span><span class="token function">LogIfLong</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token keyword">var</span> list runtime<span class="token punctuation">.</span>Object
		<span class="token keyword">var</span> paginatedResult <span class="token builtin">bool</span>
		<span class="token keyword">var</span> err <span class="token builtin">error</span>
		listCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		panicCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    
    <span class="token comment">// \u6267\u884Clist\u64CD\u4F5C</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					panicCh <span class="token operator">&lt;-</span> r
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// \u8C03\u7528list\u63A5\u53E3 \u6267\u884Clist\u7684\u5206\u9875\u67E5\u8BE2</span>
			pager <span class="token operator">:=</span> pager<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>pager<span class="token punctuation">.</span><span class="token function">SimplePageFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>opts metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> r<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">switch</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> r<span class="token punctuation">.</span>WatchListPageSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
				pager<span class="token punctuation">.</span>PageSize <span class="token operator">=</span> r<span class="token punctuation">.</span>WatchListPageSize
			<span class="token keyword">case</span> r<span class="token punctuation">.</span>paginatedResult<span class="token punctuation">:</span>
				<span class="token comment">//  // \u83B7\u5F97\u4E00\u4E2A\u521D\u59CB\u7684\u5206\u9875\u7ED3\u679C\u3002\u5047\u5B9A\u6B64\u8D44\u6E90\u548C\u670D\u52A1\u5668\u7B26\u5408\u5206\u9875\u8BF7\u6C42\uFF0C\u5E76\u4FDD\u7559\u9ED8\u8BA4\u7684\u5206\u9875\u5668\u5927\u5C0F\u8BBE\u7F6E</span>
			<span class="token keyword">case</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">!=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">:</span>
				pager<span class="token punctuation">.</span>PageSize <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">}</span>

			list<span class="token punctuation">,</span> paginatedResult<span class="token punctuation">,</span> err <span class="token operator">=</span> pager<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">isExpiredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isTooLargeResourceVersionError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				r<span class="token punctuation">.</span><span class="token function">setIsLastSyncResourceVersionUnavailable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
				list<span class="token punctuation">,</span> paginatedResult<span class="token punctuation">,</span> err <span class="token operator">=</span> pager<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>ResourceVersion<span class="token punctuation">:</span> r<span class="token punctuation">.</span><span class="token function">relistResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token function">close</span><span class="token punctuation">(</span>listCh<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token keyword">case</span> r <span class="token operator">:=</span> <span class="token operator">&lt;-</span>panicCh<span class="token punctuation">:</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>listCh<span class="token punctuation">:</span>
		<span class="token punctuation">}</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Objects listed&quot;</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span>Field<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> err<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: failed to list %v: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to list %v: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">==</span> <span class="token string">&quot;0&quot;</span> <span class="token operator">&amp;&amp;</span> paginatedResult <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>paginatedResult <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>

		r<span class="token punctuation">.</span><span class="token function">setIsLastSyncResourceVersionUnavailable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// list \u6210\u529F</span>
		listMetaInterface<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ListAccessor</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to understand list result %#v: %v&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		resourceVersion <span class="token operator">=</span> listMetaInterface<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Resource version extracted&quot;</span><span class="token punctuation">)</span>
		items<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to understand list result %#v (%v)&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Objects extracted&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// \u8FD9\u4E00\u6B65\u4F1A\u628Alist\u51FA\u6765\u7684\u6570\u636E  Replace \u5230store\u4E2D</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">syncWith</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> resourceVersion<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to sync list result: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;SyncWith done&quot;</span><span class="token punctuation">)</span>
		r<span class="token punctuation">.</span><span class="token function">setLastSyncResourceVersion</span><span class="token punctuation">(</span>resourceVersion<span class="token punctuation">)</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Resource version updated&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	resyncerrc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	cancelCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>cancelCh<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		resyncCh<span class="token punctuation">,</span> cleanup <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">resyncChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Call the last one written into cleanup</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>resyncCh<span class="token punctuation">:</span>
       <span class="token comment">//  stopCh \u4E00\u4E2A\u505C\u6B62\u5FAA\u73AF\u7684\u673A\u4F1A</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>cancelCh<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>ShouldResync <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> r<span class="token punctuation">.</span><span class="token function">ShouldResync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: forcing resync&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					resyncerrc <span class="token operator">&lt;-</span> err
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			resyncCh<span class="token punctuation">,</span> cleanup <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">resyncChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  
  <span class="token comment">// watch\u64CD\u4F5C</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// give the stopCh a chance to stop the loop, even in case of continue statements further down on errors</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token punctuation">}</span>

		timeoutSeconds <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>minWatchTimeout<span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Float64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// \u8BBE\u7F6Ewatch\u7684\u9009\u9879\uFF0C\u56E0\u4E3A\u524D\u671F\u5217\u4E3E\u4E86\u5168\u91CF\u5BF9\u8C61\uFF0C\u4ECE\u8FD9\u91CC\u53EA\u8981\u76D1\u542C\u6700\u65B0\u7248\u672C\u4EE5\u540E\u7684\u8D44\u6E90\u5C31\u53EF\u4EE5\u4E86 \u5E76\u4E14\u8BBE\u7F6E\u8D85\u65F6\u65F6\u95F4</span>
		options <span class="token operator">=</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>
			ResourceVersion<span class="token punctuation">:</span> resourceVersion<span class="token punctuation">,</span>
			TimeoutSeconds<span class="token punctuation">:</span> <span class="token operator">&amp;</span>timeoutSeconds<span class="token punctuation">,</span>
			AllowWatchBookmarks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>

		start <span class="token operator">:=</span> r<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// \u8C03\u7528 Watch \u63A5\u53E3 \u6267\u884CWatch \u64CD\u4F5C</span>
		w<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> utilnet<span class="token punctuation">.</span><span class="token function">IsConnectionRefused</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> apierrors<span class="token punctuation">.</span><span class="token function">IsTooManyRequests</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>initConnBackoffManager<span class="token punctuation">.</span><span class="token function">Backoff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>

    <span class="token comment">// \u6267\u884C watchHandler \u64CD\u4F5C</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">watchHandler</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resourceVersion<span class="token punctuation">,</span> resyncerrc<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> errorStopRequested <span class="token punctuation">{</span>
				<span class="token keyword">switch</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> <span class="token function">isExpiredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">:</span>
					klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: watch of %v closed with: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">case</span> apierrors<span class="token punctuation">.</span><span class="token function">IsTooManyRequests</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">:</span>
					klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: watch of %v returned 429 - backing off&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">)</span>
					<span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>initConnBackoffManager<span class="token punctuation">.</span><span class="token function">Backoff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
					klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: watch of %v ended with: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br></div></div><h3 id="watchhandler" tabindex="-1"><a class="header-anchor" href="#watchhandler" aria-hidden="true">#</a> watchHandler</h3><p>\u5728\u6267\u884Cwatch\u64CD\u4F5C\u65F6 \u6700\u540E\u4F1A\u6267\u884C\u4E00\u4E2AwatchHandler \u5BF9\u4E0D\u540C\u7684\u4E8B\u4EF6 \u6267\u884C\u4E0D\u540C\u7684\u5904\u7406\u65B9\u5F0F</p><p>\u5BF9\u4E8E\u589E\u5220\u6539\u64CD\u4F5C \u90FD\u4F1A\u8C03\u7528\u5E95\u5C42\u7684Store\u5BF9\u5E94\u7684\u65B9\u6CD5</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>

<span class="token comment">// watchHandler \u76D1\u542C w \u4FDD\u6301\u8D44\u6E90\u7248\u672C\u6700\u65B0</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Reflector<span class="token punctuation">)</span> <span class="token function">watchHandler</span><span class="token punctuation">(</span>start time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> w watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> resourceVersion <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">,</span> errc <span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	eventCount <span class="token operator">:=</span> <span class="token number">0</span>

	<span class="token keyword">defer</span> w<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

loop<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> errorStopRequested
		<span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errc<span class="token punctuation">:</span>
			<span class="token keyword">return</span> err
		<span class="token keyword">case</span> event<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span><span class="token function">ResultChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
				<span class="token keyword">break</span> loop
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> event<span class="token punctuation">.</span>Type <span class="token operator">==</span> watch<span class="token punctuation">.</span>Error <span class="token punctuation">{</span>
				<span class="token keyword">return</span> apierrors<span class="token punctuation">.</span><span class="token function">FromObject</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>expectedType <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> e<span class="token punctuation">,</span> a <span class="token operator">:=</span> r<span class="token punctuation">.</span>expectedType<span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> a <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: expected type %v, but watch event object had type %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>expectedGVK <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> e<span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token operator">*</span>r<span class="token punctuation">.</span>expectedGVK<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token function">GetObjectKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupVersionKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> a <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: expected gvk %v, but watch event object had gvk %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			meta<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">Accessor</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: unable to understand watch event %#v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// \u83B7\u53D6\u5F53\u524Dwatch\u5230\u7684\u8D44\u6E90\u7248\u672C\u53F7</span>
			newResourceVersion <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">switch</span> event<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>  <span class="token comment">// \u5206\u53D1\u4E8B\u4EF6</span>
			<span class="token keyword">case</span> watch<span class="token punctuation">.</span>Added<span class="token punctuation">:</span>    <span class="token comment">// add\u4E8B\u4EF6</span>
				err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: unable to add watch event object (%#v) to store: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> watch<span class="token punctuation">.</span>Modified<span class="token punctuation">:</span> <span class="token comment">// Update \u4E8B\u4EF6</span>
				err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: unable to update watch event object (%#v) to store: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> watch<span class="token punctuation">.</span>Deleted<span class="token punctuation">:</span> <span class="token comment">// Delete \u4E8B\u4EF6</span>
				err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: unable to delete watch event object (%#v) from store: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> watch<span class="token punctuation">.</span>Bookmark<span class="token punctuation">:</span>
				<span class="token comment">// A \`Bookmark\` means watch has synced here, just update the resourceVersion</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: unable to understand watch event %#v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token operator">*</span>resourceVersion <span class="token operator">=</span> newResourceVersion
			r<span class="token punctuation">.</span><span class="token function">setLastSyncResourceVersion</span><span class="token punctuation">(</span>newResourceVersion<span class="token punctuation">)</span>
			<span class="token keyword">if</span> rvu<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token punctuation">(</span>ResourceVersionUpdater<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				rvu<span class="token punctuation">.</span><span class="token function">UpdateResourceVersion</span><span class="token punctuation">(</span>newResourceVersion<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			eventCount<span class="token operator">++</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	watchDuration <span class="token operator">:=</span> r<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
	<span class="token keyword">if</span> watchDuration <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token operator">&amp;&amp;</span> eventCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;very short watch: %s: Unexpected watch close - watch lasted less than a second and no items received&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Watch close - %v total %v items received&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> eventCount<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div>`,20);function p(e,o){return t}var u=n(a,[["render",p]]);export{u as default};
