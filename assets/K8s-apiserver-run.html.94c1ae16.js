import{_ as n,f as s}from"./app.9d0d0a36.js";const a={},p=s(`<h1 id="kube-apiserver\u6E90\u7801" tabindex="-1"><a class="header-anchor" href="#kube-apiserver\u6E90\u7801" aria-hidden="true">#</a> kube-apiserver\u6E90\u7801</h1><h2 id="_1-\u5165\u53E3\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#_1-\u5165\u53E3\u51FD\u6570" aria-hidden="true">#</a> 1 \u5165\u53E3\u51FD\u6570</h2><p>cmd/kube-apiserver/apiserver.go</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

   command <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   logs<span class="token punctuation">.</span><span class="token function">InitLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">defer</span> logs<span class="token punctuation">.</span><span class="token function">FlushLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

   <span class="token keyword">if</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>\u4E3B\u8981\u662FNewAPIServerCommand()\u6267\u884C,\u63A5\u4E0B\u6765\u6211\u4EEC\u5C31\u770B\u770B\u4ED6\u7684\u6267\u884C\u8FC7\u7A0B</p><h2 id="command\u521B\u5EFA\u8FC7\u7A0B" tabindex="-1"><a class="header-anchor" href="#command\u521B\u5EFA\u8FC7\u7A0B" aria-hidden="true">#</a> Command\u521B\u5EFA\u8FC7\u7A0B</h2><p>cmd/kube-apiserver/app/server.go 1 \u521D\u59CB\u5316command \u6838\u5FC3\u4E3A\u5176\u4E2D\u7684Run()\u51FD\u6570</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// NewAPIServerCommand creates a *cobra.Command object with default parameters</span>
<span class="token keyword">func</span> <span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
   s <span class="token operator">:=</span> options<span class="token punctuation">.</span><span class="token function">NewServerRunOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
      Use<span class="token punctuation">:</span> <span class="token string">&quot;kube-apiserver&quot;</span><span class="token punctuation">,</span>
      Long<span class="token punctuation">:</span> <span class="token string">\`The Kubernetes API server validates and configures data
for the api objects which include pods, services, replicationcontrollers, and
others. The API Server services REST operations and provides the frontend to the
cluster&#39;s shared state through which all other components interact.\`</span><span class="token punctuation">,</span>
      RunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
         verflag<span class="token punctuation">.</span><span class="token function">PrintAndExitIfRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         utilflag<span class="token punctuation">.</span><span class="token function">PrintFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

         <span class="token comment">// set default options</span>
         completedOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Complete</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
         <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
         <span class="token punctuation">}</span>

         <span class="token comment">// validate options</span>
         <span class="token keyword">if</span> errs <span class="token operator">:=</span> completedOptions<span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>

         <span class="token keyword">return</span> <span class="token function">Run</span><span class="token punctuation">(</span>completedOptions<span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span>

   fs <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   namedFlagSets <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   verflag<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>namedFlagSets<span class="token punctuation">.</span><span class="token function">FlagSet</span><span class="token punctuation">(</span><span class="token string">&quot;global&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   globalflag<span class="token punctuation">.</span><span class="token function">AddGlobalFlags</span><span class="token punctuation">(</span>namedFlagSets<span class="token punctuation">.</span><span class="token function">FlagSet</span><span class="token punctuation">(</span><span class="token string">&quot;global&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   options<span class="token punctuation">.</span><span class="token function">AddCustomGlobalFlags</span><span class="token punctuation">(</span>namedFlagSets<span class="token punctuation">.</span><span class="token function">FlagSet</span><span class="token punctuation">(</span><span class="token string">&quot;generic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> namedFlagSets<span class="token punctuation">.</span>FlagSets <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">AddFlagSet</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   usageFmt <span class="token operator">:=</span> <span class="token string">&quot;Usage:\\n  %s\\n&quot;</span>
   cols<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> term<span class="token punctuation">.</span><span class="token function">TerminalSize</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">SetUsageFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStderr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> usageFmt<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">UseLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      cliflag<span class="token punctuation">.</span><span class="token function">PrintSections</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStderr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> namedFlagSets<span class="token punctuation">,</span> cols<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   cmd<span class="token punctuation">.</span><span class="token function">SetHelpFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\\n\\n&quot;</span><span class="token operator">+</span>usageFmt<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>Long<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">UseLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      cliflag<span class="token punctuation">.</span><span class="token function">PrintSections</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">OutOrStdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> namedFlagSets<span class="token punctuation">,</span> cols<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

   <span class="token keyword">return</span> cmd
<span class="token punctuation">}</span>





<span class="token comment">// completeOptions \u662F\u521D\u59CB\u5316\u7684\u6A21\u677F   stopCh\u662F\u521B\u5EFA\u7684\u65F6\u5019\u4F20\u5165\u7684\u4FE1\u53F7\u91CF \u53EF\u4EE5\u6839\u636E\u4ED6\u505C\u6B62\u8FDB\u7A0B</span>
<span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>completeOptions completedServerRunOptions<span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// To help debugging, immediately log version</span>
	klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Version: %+v&quot;</span><span class="token punctuation">,</span> version<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	server<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span>completeOptions<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	prepared<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> prepared<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h2 id="server\u7684\u521B\u5EFA" tabindex="-1"><a class="header-anchor" href="#server\u7684\u521B\u5EFA" aria-hidden="true">#</a> server\u7684\u521B\u5EFA</h2><p>\u5728\u4E0A\u8FF0\u4EE3\u7801\u4E2D\u4E3B\u8981\u548Cserver\u521B\u5EFA\u76F8\u5173\u7684\u662FCreateServerChain \u6211\u4EEC\u5C31\u6765\u770B\u770BCreateServerChain</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// \u5728CreateServerChain\u8FD9\u4E2A\u51FD\u6570\u4E0B\uFF0C\u521B\u5EFA\u4E863\u4E2Aserver</span>
<span class="token keyword">func</span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token comment">// kubeapiserver \u7684\u914D\u7F6E\u521B\u5EFA</span>
    <span class="token function">CreateKubeAPIServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// kube \u989D\u5916\u914D\u7F6E\u7684\u521B\u5EFA</span>
    <span class="token function">createAPIExtensionsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// API\u6269\u5C55\u670D\u52A1\uFF0C\u4E3B\u8981\u9488\u5BF9CRD</span>
	<span class="token function">createAPIExtensionsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
  <span class="token comment">// API\u6838\u5FC3\u670D\u52A1\uFF0C\u5305\u62EC\u5E38\u89C1\u7684Pod/Deployment/Service\uFF0C\u6211\u4EEC\u4ECA\u5929\u7684\u91CD\u70B9\u805A\u7126\u5728\u8FD9\u91CC</span>
  <span class="token comment">// \u6211\u4F1A\u8DF3\u8FC7\u5F88\u591A\u975E\u6838\u5FC3\u7684\u914D\u7F6E\u53C2\u6570\uFF0C\u4E00\u5F00\u59CB\u5C31\u53BB\u7814\u7A76\u7EC6\u8282\uFF0C\u5F88\u5F71\u54CD\u6574\u4F53\u4EE3\u7801\u7684\u9605\u8BFB\u6548\u7387</span>
	<span class="token function">CreateKubeAPIServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
  <span class="token comment">// API\u805A\u5408\u670D\u52A1\uFF0C\u4E3B\u8981\u9488\u5BF9metrics</span>
	<span class="token function">createAggregatorServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="createkubeapiserver-apiserver\u7684\u521B\u5EFA" tabindex="-1"><a class="header-anchor" href="#createkubeapiserver-apiserver\u7684\u521B\u5EFA" aria-hidden="true">#</a> CreateKubeAPIServer() apiserver\u7684\u521B\u5EFA</h2><p>cmd/kube-apiserver/app/server.go</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//\u9996\u5148\u8C03\u7528complete \u8FDB\u884C\u53C2\u6570\u7684\u586B\u5145  \u7136\u540E\u8C03\u7528new\u8FDB\u884C\u5B9E\u4F8B\u5316</span>
<span class="token keyword">func</span> <span class="token function">CreateKubeAPIServer</span><span class="token punctuation">(</span>kubeAPIServerConfig <span class="token operator">*</span>master<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> delegateAPIServer genericapiserver<span class="token punctuation">.</span>DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>master<span class="token punctuation">.</span>Master<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   kubeAPIServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubeAPIServerConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> kubeAPIServer<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>\u53EF\u89C1\u4ED6\u662F\u8C03\u7528\u4E86New\u51FD\u6570</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>delegationTarget genericapiserver<span class="token punctuation">.</span>DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Master<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">,</span> kubeletclient<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Master.New() called with empty config.KubeletClientConfig&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
	<span class="token comment">// \u4F7F\u7528\u901A\u7528\u914D\u7F6E new\u4E00\u4E2Aconfig</span>
    
   s<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;kube-apiserver&quot;</span><span class="token punctuation">,</span> delegationTarget<span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>EnableLogsSupport <span class="token punctuation">{</span>
      routes<span class="token punctuation">.</span>Logs<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">Install</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span>GoRestfulContainer<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>ServiceAccountIssuerDiscovery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Metadata and keys are expected to only change across restarts at present,</span>
      <span class="token comment">// so we just marshal immediately and serve the cached JSON bytes.</span>
      md<span class="token punctuation">,</span> err <span class="token operator">:=</span> serviceaccount<span class="token punctuation">.</span><span class="token function">NewOpenIDMetadata</span><span class="token punctuation">(</span>
         c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountIssuerURL<span class="token punctuation">,</span>
         c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountJWKSURI<span class="token punctuation">,</span>
         c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>ExternalAddress<span class="token punctuation">,</span>
         c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountPublicKeys<span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token comment">// If there was an error, skip installing the endpoints and log the</span>
         <span class="token comment">// error, but continue on. We don&#39;t return the error because the</span>
         <span class="token comment">// metadata responses require additional, backwards incompatible</span>
         <span class="token comment">// validation of command-line options.</span>
         msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Could not construct pre-rendered responses for&quot;</span><span class="token operator">+</span>
            <span class="token string">&quot; ServiceAccountIssuerDiscovery endpoints. Endpoints will not be&quot;</span><span class="token operator">+</span>
            <span class="token string">&quot; enabled. Error: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
         <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountIssuerURL <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
            <span class="token comment">// The user likely expects this feature to be enabled if issuer URL is</span>
            <span class="token comment">// set and the feature gate is enabled. In the future, if there is no</span>
            <span class="token comment">// longer a feature gate and issuer URL is not set, the user may not</span>
            <span class="token comment">// expect this feature to be enabled. We log the former case as an Error</span>
            <span class="token comment">// and the latter case as an Info.</span>
            klog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         routes<span class="token punctuation">.</span><span class="token function">NewOpenIDMetadataServer</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span>ConfigJSON<span class="token punctuation">,</span> md<span class="token punctuation">.</span>PublicKeysetJSON<span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">Install</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span>GoRestfulContainer<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>
      GenericAPIServer<span class="token punctuation">:</span>          s<span class="token punctuation">,</span>
      ClusterAuthenticationInfo<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// install legacy rest storage</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">.</span><span class="token function">VersionEnabled</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      legacyRESTStorageProvider <span class="token operator">:=</span> corerest<span class="token punctuation">.</span>LegacyRESTStorageProvider<span class="token punctuation">{</span>
         StorageFactory<span class="token punctuation">:</span>              c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>StorageFactory<span class="token punctuation">,</span>
         ProxyTransport<span class="token punctuation">:</span>              c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ProxyTransport<span class="token punctuation">,</span>
         KubeletClientConfig<span class="token punctuation">:</span>         c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">,</span>
         EventTTL<span class="token punctuation">:</span>                    c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>EventTTL<span class="token punctuation">,</span>
         ServiceIPRange<span class="token punctuation">:</span>              c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceIPRange<span class="token punctuation">,</span>
         SecondaryServiceIPRange<span class="token punctuation">:</span>     c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>SecondaryServiceIPRange<span class="token punctuation">,</span>
         ServiceNodePortRange<span class="token punctuation">:</span>        c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceNodePortRange<span class="token punctuation">,</span>
         LoopbackClientConfig<span class="token punctuation">:</span>        c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>
         ServiceAccountIssuer<span class="token punctuation">:</span>        c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountIssuer<span class="token punctuation">,</span>
         ServiceAccountMaxExpiration<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ServiceAccountMaxExpiration<span class="token punctuation">,</span>
         APIAudiences<span class="token punctuation">:</span>                c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// The order here is preserved in discovery.</span>
   <span class="token comment">// If resources with identical names exist in more than one of these groups (e.g. &quot;deployments.apps&quot;&quot; and &quot;deployments.extensions&quot;),</span>
   <span class="token comment">// the order of this list determines which group an unqualified resource name (e.g. &quot;deployments&quot;) should prefer.</span>
   <span class="token comment">// This priority order is used for local discovery, but it ends up aggregated in \`k8s.io/kubernetes/cmd/kube-apiserver/app/aggregator.go</span>
   <span class="token comment">// with specific priorities.</span>
   <span class="token comment">// TODO: describe the priority all the way down in the RESTStorageProviders and plumb it back through the various discovery</span>
   <span class="token comment">// handlers that we have.</span>
   restStorageProviders <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>RESTStorageProvider<span class="token punctuation">{</span>
      auditregistrationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      authenticationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authenticator<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> APIAudiences<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">}</span><span class="token punctuation">,</span>
      authorizationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authorizer<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> RuleResolver<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">}</span><span class="token punctuation">,</span>
      autoscalingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      batchrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      certificatesrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      coordinationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      discoveryrest<span class="token punctuation">.</span>StorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      extensionsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      networkingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      noderest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      policyrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      rbacrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authorizer<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">}</span><span class="token punctuation">,</span>
      schedulingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      settingsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      storagerest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      flowcontrolrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.</span>
      <span class="token comment">// See https://github.com/kubernetes/kubernetes/issues/42392</span>
      appsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      admissionregistrationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      eventsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>TTL<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>EventTTL<span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>Tunneler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      m<span class="token punctuation">.</span><span class="token function">installTunneler</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>Tunneler<span class="token punctuation">,</span> corev1client<span class="token punctuation">.</span><span class="token function">NewForConfigOrDie</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHookOrDie</span><span class="token punctuation">(</span><span class="token string">&quot;start-cluster-authentication-info-controller&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>hookContext genericapiserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
      kubeClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubernetes<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>hookContext<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> err
      <span class="token punctuation">}</span>
      controller <span class="token operator">:=</span> clusterauthenticationtrust<span class="token punctuation">.</span><span class="token function">NewClusterAuthenticationTrustController</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span> kubeClient<span class="token punctuation">)</span>

      <span class="token comment">// prime values and start listeners</span>
      <span class="token keyword">if</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>ClientCA <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> notifier<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>ClientCA<span class="token punctuation">.</span><span class="token punctuation">(</span>dynamiccertificates<span class="token punctuation">.</span>Notifier<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            notifier<span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span> controller<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>ClientCA<span class="token punctuation">.</span><span class="token punctuation">(</span>dynamiccertificates<span class="token punctuation">.</span>ControllerRunner<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token comment">// runonce to be sure that we have a value.</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">RunOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
               runtime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">go</span> controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> hookContext<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>RequestHeaderCA <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> notifier<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>RequestHeaderCA<span class="token punctuation">.</span><span class="token punctuation">(</span>dynamiccertificates<span class="token punctuation">.</span>Notifier<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            notifier<span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span> controller<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">.</span>RequestHeaderCA<span class="token punctuation">.</span><span class="token punctuation">(</span>dynamiccertificates<span class="token punctuation">.</span>ControllerRunner<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token comment">// runonce to be sure that we have a value.</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">RunOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
               runtime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">go</span> controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> hookContext<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">go</span> controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> hookContext<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

   <span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br></div></div><h2 id="genericconfig-new-\u8BBE\u7F6E\u7684\u521D\u59CB\u5316" tabindex="-1"><a class="header-anchor" href="#genericconfig-new-\u8BBE\u7F6E\u7684\u521D\u59CB\u5316" aria-hidden="true">#</a> GenericConfig.New() \u8BBE\u7F6E\u7684\u521D\u59CB\u5316</h2><p>\u5728\u4E0A\u8FF0\u4EE3\u7801\u4E2D \u6709\u7528new\u8FDB\u884C\u521D\u59CB\u5316\u4E86\u4E00\u4E2Aconfig\u5BF9\u8C61</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// \u90FD\u901A\u8FC7GenericConfig\u521B\u5EFA\u4E86genericServer\uFF0C\u6211\u4EEC\u5148\u5927\u81F4\u6D4F\u89C8\u4E0B</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> delegationTarget DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>GenericAPIServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// \u65B0\u5EFAHandler</span>
	apiServerHandler <span class="token operator">:=</span> <span class="token function">NewAPIServerHandler</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> handlerChainBuilder<span class="token punctuation">,</span> delegationTarget<span class="token punctuation">.</span><span class="token function">UnprotectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  
	<span class="token comment">// \u5B9E\u4F8B\u5316\u4E00\u4E2AServer</span>
	s <span class="token operator">:=</span> <span class="token operator">&amp;</span>GenericAPIServer<span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

	<span class="token comment">// \u5904\u7406\u94A9\u5B50hook\u64CD\u4F5C</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> delegationTarget<span class="token punctuation">.</span><span class="token function">PostStartHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>postStartHooks<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> delegationTarget<span class="token punctuation">.</span><span class="token function">PreShutdownHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>preShutdownHooks<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>

	<span class="token comment">// \u5065\u5EB7\u76D1\u6D4B</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> delegateCheck <span class="token operator">:=</span> <span class="token keyword">range</span> delegationTarget<span class="token punctuation">.</span><span class="token function">HealthzChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		skip <span class="token operator">:=</span> <span class="token boolean">false</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> existingCheck <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>HealthzChecks <span class="token punctuation">{</span>
			<span class="token keyword">if</span> existingCheck<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> delegateCheck<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				skip <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> skip <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		s<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span>delegateCheck<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
  <span class="token comment">// \u5B89\u88C5API\u76F8\u5173\u53C2\u6570\uFF0C\u8FD9\u4E2A\u662F\u91CD\u70B9</span>
	<span class="token function">installAPI</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>

	<span class="token keyword">return</span> s<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="apiserver\u7684\u521B\u5EFA" tabindex="-1"><a class="header-anchor" href="#apiserver\u7684\u521B\u5EFA" aria-hidden="true">#</a> Apiserver\u7684\u521B\u5EFA</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>delegationTarget genericapiserver<span class="token punctuation">.</span>DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Master<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// genericServer\u7684\u521D\u59CB\u5316</span>
	s<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;kube-apiserver&quot;</span><span class="token punctuation">,</span> delegationTarget<span class="token punctuation">)</span>
	<span class="token comment">// \u6838\u5FC3KubeAPIServer\u7684\u5B9E\u4F8B\u5316</span>
	m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>
		GenericAPIServer<span class="token punctuation">:</span>          s<span class="token punctuation">,</span>
		ClusterAuthenticationInfo<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// \u6CE8\u518CLegacy API\u7684\u6CE8\u518C</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">.</span><span class="token function">VersionEnabled</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		legacyRESTStorageProvider <span class="token operator">:=</span> corerest<span class="token punctuation">.</span>LegacyRESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// REST\u63A5\u53E3\u7684\u5B58\u50A8\u5B9A\u4E49\uFF0C\u53EF\u4EE5\u770B\u5230\u5F88\u591Ak8s\u4E0A\u7684\u5E38\u89C1\u5B9A\u4E49\uFF0C\u6BD4\u5982node\u8282\u70B9/storage\u5B58\u50A8/event\u4E8B\u4EF6\u7B49\u7B49</span>
	restStorageProviders <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>RESTStorageProvider<span class="token punctuation">{</span>
		authenticationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authenticator<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> APIAudiences<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">}</span><span class="token punctuation">,</span>
		authorizationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authorizer<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> RuleResolver<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">}</span><span class="token punctuation">,</span>
		autoscalingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		batchrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		certificatesrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		coordinationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		discoveryrest<span class="token punctuation">.</span>StorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		extensionsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		networkingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		noderest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		policyrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		rbacrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>Authorizer<span class="token punctuation">:</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">}</span><span class="token punctuation">,</span>
		schedulingrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		settingsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		storagerest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		flowcontrolrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.</span>
		<span class="token comment">// See https://github.com/kubernetes/kubernetes/issues/42392</span>
		appsrest<span class="token punctuation">.</span>StorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		admissionregistrationrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		eventsrest<span class="token punctuation">.</span>RESTStorageProvider<span class="token punctuation">{</span>TTL<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>EventTTL<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// \u6CE8\u518CAPI</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// \u6DFB\u52A0Hook</span>
	m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHookOrDie</span><span class="token punctuation">(</span><span class="token string">&quot;start-cluster-authentication-info-controller&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>hookContext genericapiserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div>`,21);function t(e,o){return p}var u=n(a,[["render",t]]);export{u as default};
